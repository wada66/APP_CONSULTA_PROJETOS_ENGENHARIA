{% extends "base.html" %}

{% block content %}
<div class="projetos-container">
    <div class="page-header">
        <h2>Consulta de Projetos</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Voltar</a>
    </div>
    
    <!-- Filtros -->
    <div class="filtros-section">
        <h3 class="filtros-title">üîç FILTROS:</h3>
        
        <form method="GET" action="{{ url_for('listar_projetos') }}" class="filtros-form">
            <div class="filtros-grid">
                <!-- Linha 1 -->
                <div class="filtro-group">
                    <label>ID do Projeto:</label>
                    <input type="number" name="id_projen" value="{{ filtros.get('id_projen', '') }}" 
                           placeholder="Digite o ID" min="1">
                </div>
                
                <div class="filtro-group">
                    <label>N¬∫ de Chamada:</label>
                    <input type="text" name="n_chamada" value="{{ filtros.get('n_chamada', '') }}" 
                           placeholder="N√∫mero de chamada">
                </div>
                
                <!-- Linha 2 - T√≠tulo do Projeto e Autor -->
                <div class="filtro-group full-width">
                    <label>T√≠tulo do Projeto:</label>
                    <input type="text" name="titulo" value="{{ filtros.get('titulo', '') }}" 
                        placeholder="Digite palavras do t√≠tulo..." style="width: 100%;">
                </div>

                <!-- Linha: Autor com sele√ß√£o de tipo -->
                <div class="filtro-group autor-completo">
                    <label>Autor:</label>
                    
                    <!-- Container para os dois selects lado a lado -->
                    <div class="autor-dual-select">
                        <!-- Select do Autor -->
                        <select name="autor_id" class="select2-autor autor-select">
                            <option value="">Selecione um autor...</option>
                            {% for autor in autores %}
                            <option value="{{ autor.id_autor }}" 
                                    data-tipo="{{ autor.tipo_autor }}"
                                    {% if filtros.get('autor_id')|string == autor.id_autor|string %}selected{% endif %}>
                                {{ autor.nome_autor }} ({{ autor.tipo_autor }})
                            </option>
                            {% endfor %}
                        </select>
                        
                        <!-- Select do Tipo (menor) -->
                        <select name="autor_tipo" class="tipo-select" 
                                {% if not filtros.get('autor_id') %}disabled{% endif %}>
                            <option value="todos" {% if filtros.get('autor_tipo', 'todos') == 'todos' %}selected{% endif %}>
                                Todos os tipos
                            </option>
                            <option value="primario" {% if filtros.get('autor_tipo') == 'primario' %}selected{% endif %}>
                                Apenas Prim√°rio
                            </option>
                            <option value="secundario" {% if filtros.get('autor_tipo') == 'secundario' %}selected{% endif %}>
                                Apenas Secund√°rio
                            </option>
                        </select>
                    </div>
                    
                    <!-- Mensagem de ajuda -->
                    <small class="help-text">
                        Selecione um autor e escolha o tipo (opcional)
                    </small>
                </div>
                
                <!-- Linha 3 - Local e Data -->
                <div class="filtro-group">
                    <label>Local:</label>
                    <select name="local_id">
                        <option value="">Todos os locais...</option>
                        {% for local in locais %}
                        <option value="{{ local.id_local }}" 
                                {% if filtros.get('local_id')|string == local.id_local|string %}selected{% endif %}>
                            {{ local.nome_local }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label>Data (M√™s/Ano):</label>
                    <div class="date-inputs">
                        <input type="number" name="mes" value="{{ filtros.get('mes', '') }}" 
                               placeholder="M√™s (1-12)" min="1" max="12">
                        <input type="number" name="ano" value="{{ filtros.get('ano', datetime.now().year) }}" 
                               placeholder="Ano" min="1900" max="2100">
                    </div>
                </div>
                
                <!-- Linha 4 - Conte√∫do e Executor -->
                <div class="filtro-group">
                    <label>Conte√∫do:</label>
                    <select name="conteudo" class="select2-conteudo">
                        <option value="">Selecione um conte√∫do...</option>
                        {% for conteudo in conteudos %}
                        <option value="{{ conteudo }}" 
                                {% if filtros.get('conteudo') == conteudo %}selected{% endif %}>
                            {{ conteudo[:50] }}{% if conteudo|length > 50 %}...{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label>Executor:</label>
                    <select name="executor_id">
                        <option value="">Todos os executores...</option>
                        {% for executor in executores %}
                        <option value="{{ executor.id_executor }}" 
                                {% if filtros.get('executor_id')|string == executor.id_executor|string %}selected{% endif %}>
                            {{ executor.nome_executor }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Linha 5 - Assunto e Setor -->
                <div class="filtro-group">
                    <label>Assunto:</label>
                    <select name="assunto_id">
                        <option value="">Todos os assuntos...</option>
                        {% for assunto in assuntos %}
                        <option value="{{ assunto.id_assunto }}" 
                                {% if filtros.get('assunto_id')|string == assunto.id_assunto|string %}selected{% endif %}>
                            {{ assunto.nome_assunto }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label>Setor:</label>
                    <select name="setor_id">
                        <option value="">Todos os setores...</option>
                        {% for setor in setores %}
                        <option value="{{ setor.id_setor }}" 
                                {% if filtros.get('setor_id')|string == setor.id_setor|string %}selected{% endif %}>
                            {{ setor.nome_setor }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                <a href="{{ url_for('listar_projetos') }}" class="btn btn-secondary">Limpar Filtros</a>
            </div>
        </form>
    </div>
    
    <!-- Resultados -->
    <div class="resultados-section">
        <h3>Resultados ({{ projetos|length }} projetos encontrados)</h3>
        
        {% if projetos %}
        <div class="projetos-list">
            {% for projeto in projetos %}
            <div class="projeto-card">
                <div class="projeto-header">
                    <h4>#{{ projeto.id_projen }} - {{ projeto.titulo_projen }}</h4>
                    <span class="projeto-chamada">{{ projeto.n_chamada_projen }}</span>
                </div>
                
                <div class="projeto-details">
                    <p><strong>Data:</strong> {{ projeto.data_projen.strftime('%d/%m/%Y') if projeto.data_projen else 'N/A' }}</p>
                    <p><strong>Local:</strong> {{ projeto.local.nome_local if projeto.local else 'N/A' }}</p>
                    <p><strong>Setor:</strong> {{ projeto.setor.nome_setor if projeto.setor else 'N/A' }}</p>
                    
                    <div class="projeto-tags">
                        {% if projeto.autores %}
                        <span class="tag">üë• Autores: {{ projeto.autores|map(attribute='nome_autor')|join(', ') }}</span>
                        {% endif %}
                        {% if projeto.assuntos %}
                        <span class="tag">üè∑Ô∏è Assuntos: {{ projeto.assuntos|map(attribute='nome_assunto')|join(', ') }}</span>
                        {% endif %}
                        {% if projeto.executores %}
                        <span class="tag">üõ†Ô∏è Executores: {{ projeto.executores|map(attribute='nome_executor')|join(', ') }}</span>
                        {% endif %}
                    </div>
                    
                    <p class="projeto-conteudo">
                        <strong>Conte√∫do:</strong> 
                        {% if projeto.conteudo_projen %}
                            {{ projeto.conteudo_projen[:200] }}{% if projeto.conteudo_projen|length > 200 %}...{% endif %}
                        {% else %}
                            N√£o dispon√≠vel
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <p>Nenhum projeto encontrado com os filtros aplicados.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Inicializar Select2 para autores
    $('.select2-autor').select2({
        placeholder: "Selecione um autor...",
        allowClear: true,
        language: "pt-BR",
        width: '100%'
    });
    
    // Inicializar Select2 para conte√∫dos
    $('.select2-conteudo').select2({
        placeholder: "Selecione um conte√∫do...",
        allowClear: true,
        language: "pt-BR",
        width: '100%'
    });
});
</script>
<script>
$(document).ready(function() {
    // ========== C√ìDIGO EXISTENTE ==========
    // Inicializar Select2 para autores
    $('.select2-autor').select2({
        placeholder: "Selecione um autor...",
        allowClear: true,
        language: "pt-BR",
        width: '100%'
    });
    
    // Inicializar Select2 para conte√∫dos
    $('.select2-conteudo').select2({
        placeholder: "Selecione um conte√∫do...",
        allowClear: true,
        language: "pt-BR",
        width: '100%'
    });
    
    // ========== NOVO C√ìDIGO PARA AUTORES ==========
    // L√≥gica para habilitar/desabilitar o select de tipo
    const autorSelect = $('select[name="autor_id"]');
    const tipoSelect = $('select[name="autor_tipo"]');
    
    // Ao carregar a p√°gina
    if (!autorSelect.val()) {
        tipoSelect.prop('disabled', true);
    }
    
    // Quando mudar o autor
    autorSelect.on('change', function() {
        if ($(this).val()) {
            tipoSelect.prop('disabled', false);
            
            // Mostrar o tipo do autor selecionado como sugest√£o
            const selectedOption = $(this).find('option:selected');
            const autorTipo = selectedOption.data('tipo');
            
            if (autorTipo) {
                // Mostrar tooltip (opcional)
                tipoSelect.attr('title', `Este autor √© do tipo: ${autorTipo}`);
            }
        } else {
            tipoSelect.prop('disabled', true);
            tipoSelect.val('todos');
        }
    });
});
</script>
{% endblock %}